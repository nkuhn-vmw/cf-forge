name: CF Forge Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options: [staging, production]
      action:
        description: 'Deploy action'
        required: true
        type: choice
        options: [full, apps-only, services-only, migrate-only, smoke-test]
        default: full
      component:
        description: 'Single component (leave empty for all)'
        required: false
        type: string

  push:
    branches: [main]
    paths:
      - 'cf-forge-*/src/**'
      - 'cf-forge-ui/src/**'
      - 'pom.xml'

concurrency:
  group: deploy-${{ github.event.inputs.environment || 'staging' }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build Spring Boot modules
        run: ./mvnw -q package -DskipTests

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: cf-forge-ui/package-lock.json

      - name: Build frontend
        working-directory: cf-forge-ui
        run: npm ci && npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cf-forge-artifacts
          retention-days: 1
          path: |
            cf-forge-api/target/*.jar
            cf-forge-agent/target/*.jar
            cf-forge-builder/target/*.jar
            cf-forge-workspace/target/*.jar
            cf-forge-admin/target/*.jar
            cf-forge-ui/dist/

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run tests
        run: ./mvnw verify

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Test Results
          path: '**/surefire-reports/*.xml'
          reporter: java-junit

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: cf-forge-artifacts

      - name: Install CF CLI
        run: |
          wget -q -O cf-cli.deb "https://packages.cloudfoundry.org/stable?release=debian64&version=v8&source=github"
          sudo dpkg -i cf-cli.deb

      - name: Write deploy config
        run: |
          cat > scripts/deploy-config.sh << 'ENDCONFIG'
          CF_API="${{ vars.CF_API }}"
          CF_ORG="${{ vars.CF_ORG }}"
          CF_SPACE="${{ vars.CF_SPACE }}"
          CF_SKIP_SSL="${{ vars.CF_SKIP_SSL || 'false' }}"
          CF_APPS_DOMAIN="${{ vars.CF_APPS_DOMAIN }}"
          CF_INTERNAL_DOMAIN="${{ vars.CF_INTERNAL_DOMAIN || 'apps.internal' }}"
          GENAI_SERVICE_TYPE="${{ vars.GENAI_SERVICE_TYPE }}"
          GENAI_PLAN="${{ vars.GENAI_PLAN }}"
          GENAI_INSTANCE_NAME="${{ vars.GENAI_INSTANCE_NAME || 'cf-forge-genai' }}"
          GENAI_USER_PROVIDED="${{ vars.GENAI_USER_PROVIDED || 'false' }}"
          GENAI_BASE_URL="${{ secrets.GENAI_BASE_URL }}"
          GENAI_API_KEY="${{ secrets.GENAI_API_KEY }}"
          GENAI_MODEL="${{ vars.GENAI_MODEL }}"
          SSO_SERVICE_TYPE="${{ vars.SSO_SERVICE_TYPE }}"
          SSO_PLAN="${{ vars.SSO_PLAN }}"
          SSO_INSTANCE_NAME="${{ vars.SSO_INSTANCE_NAME || 'cf-forge-sso' }}"
          SSO_USER_PROVIDED="${{ vars.SSO_USER_PROVIDED || 'false' }}"
          SSO_AUTH_DOMAIN="${{ secrets.SSO_AUTH_DOMAIN }}"
          SSO_CLIENT_ID="${{ secrets.SSO_CLIENT_ID }}"
          SSO_CLIENT_SECRET="${{ secrets.SSO_CLIENT_SECRET }}"
          DB_SERVICE_TYPE="${{ vars.DB_SERVICE_TYPE }}"
          DB_PLAN="${{ vars.DB_PLAN }}"
          DB_INSTANCE_NAME="${{ vars.DB_INSTANCE_NAME || 'cf-forge-db' }}"
          REDIS_SERVICE_TYPE="${{ vars.REDIS_SERVICE_TYPE }}"
          REDIS_PLAN="${{ vars.REDIS_PLAN }}"
          REDIS_INSTANCE_NAME="${{ vars.REDIS_INSTANCE_NAME || 'cf-forge-cache' }}"
          MQ_SERVICE_TYPE="${{ vars.MQ_SERVICE_TYPE }}"
          MQ_PLAN="${{ vars.MQ_PLAN }}"
          MQ_INSTANCE_NAME="${{ vars.MQ_INSTANCE_NAME || 'cf-forge-mq' }}"
          OBJECT_STORE_ENDPOINT="${{ secrets.OBJECT_STORE_ENDPOINT }}"
          OBJECT_STORE_ACCESS_KEY="${{ secrets.OBJECT_STORE_ACCESS_KEY }}"
          OBJECT_STORE_SECRET_KEY="${{ secrets.OBJECT_STORE_SECRET_KEY }}"
          OBJECT_STORE_BUCKET="${{ vars.OBJECT_STORE_BUCKET || 'cf-forge-artifacts' }}"
          OBJECT_STORE_REGION="${{ vars.OBJECT_STORE_REGION || 'us-east-1' }}"
          OBJECT_STORE_INSTANCE_NAME="${{ vars.OBJECT_STORE_INSTANCE_NAME || 'cf-forge-object-store' }}"
          API_INSTANCES="${{ vars.API_INSTANCES || '3' }}"
          API_MEMORY="${{ vars.API_MEMORY || '1G' }}"
          AGENT_INSTANCES="${{ vars.AGENT_INSTANCES || '2' }}"
          AGENT_MEMORY="${{ vars.AGENT_MEMORY || '2G' }}"
          BUILDER_INSTANCES="${{ vars.BUILDER_INSTANCES || '2' }}"
          BUILDER_MEMORY="${{ vars.BUILDER_MEMORY || '2G' }}"
          WORKSPACE_INSTANCES="${{ vars.WORKSPACE_INSTANCES || '2' }}"
          WORKSPACE_MEMORY="${{ vars.WORKSPACE_MEMORY || '1G' }}"
          ADMIN_INSTANCES="${{ vars.ADMIN_INSTANCES || '2' }}"
          ADMIN_MEMORY="${{ vars.ADMIN_MEMORY || '1G' }}"
          UI_INSTANCES="${{ vars.UI_INSTANCES || '2' }}"
          UI_MEMORY="${{ vars.UI_MEMORY || '256M' }}"
          CVE_SCAN_ENABLED="${{ vars.CVE_SCAN_ENABLED || 'true' }}"
          CVE_BLOCK_SEVERITY="${{ vars.CVE_BLOCK_SEVERITY || 'critical' }}"
          ADMIN_ENABLED="${{ vars.ADMIN_ENABLED || 'true' }}"
          SPRING_PROFILES="${{ vars.SPRING_PROFILES || 'cloud,production' }}"
          API_JAR="cf-forge-api/target/cf-forge-api-0.1.0-SNAPSHOT.jar"
          AGENT_JAR="cf-forge-agent/target/cf-forge-agent-0.1.0-SNAPSHOT.jar"
          BUILDER_JAR="cf-forge-builder/target/cf-forge-builder-0.1.0-SNAPSHOT.jar"
          WORKSPACE_JAR="cf-forge-workspace/target/cf-forge-workspace-0.1.0-SNAPSHOT.jar"
          ADMIN_JAR="cf-forge-admin/target/cf-forge-admin-0.1.0-SNAPSHOT.jar"
          UI_DIST="cf-forge-ui/dist"
          ENDCONFIG

      - name: CF Login
        run: cf login -a "${{ vars.CF_API }}" -u "${{ secrets.CF_USERNAME }}" -p "${{ secrets.CF_PASSWORD }}" -o "${{ vars.CF_ORG }}" -s "${{ vars.CF_SPACE }}"

      - name: Deploy
        run: |
          ACTION="${{ github.event.inputs.action || 'full' }}"
          COMPONENT="${{ github.event.inputs.component }}"
          if [[ -n "${COMPONENT}" ]]; then
            ./scripts/deploy.sh --component "${COMPONENT}"
          else
            ./scripts/deploy.sh "--${ACTION}"
          fi

      - name: Smoke test
        if: contains(fromJSON('["full", "apps-only"]'), github.event.inputs.action || 'full')
        run: ./scripts/deploy.sh --smoke-test

      - name: Summary
        if: always()
        run: |
          echo "## CF Forge Deploy Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Action:** ${{ github.event.inputs.action || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** https://forge-api.${{ vars.CF_APPS_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
          echo "- **UI:** https://forge.${{ vars.CF_APPS_DOMAIN }}" >> $GITHUB_STEP_SUMMARY
